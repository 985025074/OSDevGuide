# 3e1b15218d744ff2721c719fe43c7210fd2538e4 修改总结

本文总结 `os/` 目录提交 `3e1b15218d744ff2721c719fe43c7210fd2538e4`（commit message: `add some functions and add more syscalls`）做的修改。

该提交的核心目的是提升 Linux 用户态兼容性：补齐一些常被 glibc/busybox/rt-tests 探测或使用的 syscall，并为 `/proc`、`/sys`、`/dev` 提供最小可用的“伪文件（pseudo files）”。

## 1. 变更统计

`7 files changed, 258 insertions(+), 6 deletions(-)`，涉及：

- [os/src/fs/mod.rs](../../os/src/fs/mod.rs)
- [os/src/fs/pseudo.rs](../../os/src/fs/pseudo.rs)（新增）
- [os/src/mm/memory_set.rs](../../os/src/mm/memory_set.rs)
- [os/src/syscall/filesystem.rs](../../os/src/syscall/filesystem.rs)
- [os/src/syscall/misc.rs](../../os/src/syscall/misc.rs)
- [os/src/syscall/mod.rs](../../os/src/syscall/mod.rs)
- [os/src/syscall/process.rs](../../os/src/syscall/process.rs)

## 2. 新增伪文件 PseudoFile（/sys、/proc、/dev）

### 2.1 新增 [os/src/fs/pseudo.rs](../../os/src/fs/pseudo.rs)

引入 `PseudoFile`，实现 `File` trait，内部用 `PseudoKind` 表示不同的伪设备/伪文件：

- `Static(Vec<u8>)`：只读静态内容（带 offset，支持多次 read）
- `Urandom(u64)`：简易伪随机（xorshift64\*）
- `Null`：`read()` 返回 0；`write()` 吃掉所有输入并返回写入长度
- `Zero`：`read()` 填充 0

### 2.2 在 openat 中识别并打开伪文件

在 [os/src/syscall/filesystem.rs](../../os/src/syscall/filesystem.rs) 的 `syscall_openat` 增加：

- 若 path 以 `/sys/`、`/proc/`、`/dev/` 开头，则尝试 `open_pseudo(path)`
- 若匹配，直接分配 fd 并放入 `fd_table`，不走 ext4/inode 真实路径

目前 `open_pseudo()` 覆盖的典型路径包括：

- `/sys/devices/system/cpu/{possible,present,online}`：返回 `0-(MAX_HARTS-1)` 这样的范围字符串
- `/sys/devices/system/cpu/kernel_max`：返回 `MAX_HARTS-1`
- `/sys/devices/system/node/{online,possible}`：返回 `0`
- `/proc/loadavg`：返回固定字符串 `0.00 0.00 0.00 1/1 1`
- `/dev/null`、`/dev/zero`
- `/dev/{urandom,random}`：用 `time ^ (hart_id<<32)` 做 seed

这类文件在真实 Linux 上经常被用户态读取（CPU/NUMA 拓扑探测、随机源、loadavg），缺失时很多程序会报错或走到不兼容分支。

### 2.3 fs 模块导出

在 [os/src/fs/mod.rs](../../os/src/fs/mod.rs) 中：

- 新增 `mod pseudo;`
- `pub use pseudo::PseudoFile;` 供 syscall 层使用

## 3. 新增/接入更多 syscall：setpgid/getsid/setsid

### 3.1 在 syscall 分发表登记

在 [os/src/syscall/mod.rs](../../os/src/syscall/mod.rs) 中新增并分发：

- `SYSCALL_SETPGID = 154` → `misc::syscall_setpgid(pid, pgid)`
- `SYSCALL_GETSID = 156` → `misc::syscall_getsid(pid)`
- `SYSCALL_SETSID = 157` → `misc::syscall_setsid()`

### 3.2 最小兼容实现

在 [os/src/syscall/misc.rs](../../os/src/syscall/misc.rs) 新增：

- `syscall_setpgid`：当前内核不建模 process group，直接返回 0（成功）
- `syscall_getsid`：`pid==0` 返回当前 pid；否则返回传入 pid（最小语义）
- `syscall_setsid`：不建模 session，直接返回当前 pid 作为 sid

这些接口常用于 shell/job control 或运行时探测；“返回成功/给出合理值”可以显著提升兼容性。

## 4. wait4 状态码编码更贴近 Linux

在 [os/src/syscall/process.rs](../../os/src/syscall/process.rs) 的 `syscall_wait4` 中：

- 将写入 `wstatus_ptr` 的值改为 Linux 风格 wait status：
  - 正常退出：`(exit_code & 0xff) << 8`
  - 被信号终止：低 7 位写入 signal number（这里用负的 exit_code 表示 signal）

这能让 busybox/测试程序使用 `WIFEXITED/WEXITSTATUS/WIFSIGNALED` 等宏时得到符合预期的结果。

## 5. MemorySet 映射路径的 OOM 处理更稳健

在 [os/src/mm/memory_set.rs](../../os/src/mm/memory_set.rs) 中：

- `MapArea::map_one()` 从 `()` 改为返回 `bool`
- 若 `frame_alloc()` 失败（OOM），打印日志并返回 `false`
- `map()`/`append_to()` 在 `map_one()` 失败时 `break`，避免直接 `unwrap()` panic

这类改动主要用于提升在内存压力下的鲁棒性，减少因为偶发 OOM 造成的内核崩溃。
